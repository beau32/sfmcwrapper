<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>SFMC Automation & SQL Graph with Filter</title>
    <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
    <style>
      #cy {
        width: 100%;
        height: 750px;
        border: 1px solid #ccc;
        margin-top: 10px;
      }
      #filter {
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <h2>SFMC Automation & SQL Graph</h2>

    <div style="display: flex; gap: 20px">
      <!-- Left column -->
      <div style="flex: 0 0 250px">
        <!-- Legend -->

        <!-- Filter -->
        <div id="filter">
          <label for="automationSelect"><b>Filter by Automation(s):</b></label
          ><br />
          <select
            id="automationSelect"
            multiple
            size="6"
            style="width: 100%; margin-top: 6px"
          >
            <option value="all" selected>All Automations</option>
          </select>
        </div>
      </div>

      <!-- Right column (graph) -->
      <div style="flex: 1">
        <div
          id="legend"
          style="
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
          "
        >
          <div style="display: flex; align-items: center; gap: 6px">
            <span
              style="
                display: inline-block;
                width: 20px;
                height: 15px;
                background: #ff9800;
                border-radius: 6px;
              "
            ></span>
            <span>Automation</span>
          </div>
          <div style="display: flex; align-items: center; gap: 6px">
            <span
              style="
                display: inline-block;
                width: 15px;
                height: 15px;
                background: #4cafef;
                transform: rotate(45deg);
              "
            ></span>
            <span>SQL Activity</span>
          </div>
          <div style="display: flex; align-items: center; gap: 6px">
            <span
              style="
                display: inline-block;
                width: 20px;
                height: 15px;
                background: #1e88e5;
                border: 2px solid #0d47a1;
              "
            ></span>
            <span>Target DE</span>
          </div>
          <div style="display: flex; align-items: center; gap: 6px">
            <span
              style="
                display: inline-block;
                width: 20px;
                height: 15px;
                background: #90caf9;
                border: 1px solid #666;
              "
            ></span>
            <span>Source DE</span>
          </div>
          <div style="display: flex; align-items: center; gap: 6px">
            <span
              style="
                display: inline-block;
                width: 30px;
                height: 2px;
                background: #aaa;
              "
            ></span>
            <span>Data Flow</span>
          </div>
        </div>
        <div
          id="cy"
          style="width: 100%; height: 750px; border: 1px solid #ccc"
        ></div>
      </div>
    </div>

    <script>
      let activities = [];
      let automations = [];

      Promise.all([
          fetch("activities.json").then(res => {
              if (!res.ok) throw new Error("Failed to load activities.json");
              return res.json();
          }),
          fetch("automations.json").then(res => {
              if (!res.ok) throw new Error("Failed to load automations.json");
              return res.json();
          })
      ])
      .then(([ajexactivities, ajexautomations]) => {
          activities = ajexactivities;
          automations = ajexautomations;

          console.log("Activities loaded:", activities.length);
          console.log("Automations loaded:", automations.length);

          // Filter automations that have at least one activity
          automations = automations.filter(auto =>
            activities.some(act => act.automationId === auto.automationId)
          );
          // Automations

          let nodes = {};
          let edges = [];

          // Populate dropdown
          const select = document.getElementById("automationSelect");
          automations.forEach((a) => {
            let opt = document.createElement("option");
            opt.value = a.automationId;
            opt.text = a.name;
            select.appendChild(opt);
          });

          // Add automation nodes
          automations.forEach((a) => {
            nodes[a.automationId] = {
              data: {
                id: a.automationId,
                label: a.name,
                type: "automation",
              },
            };
          });

          // Add query/step nodes and edges
          activities.forEach((act, i) => {
            const queryNodeId = "Query_" + i;
            nodes[queryNodeId] = {
              data: {
                id: queryNodeId,
                label: `Step ${act.stepId}`,
                sql: act.queryText,
                automationId: act.automationId,
                type: "query",
              },
            };

            // Edge: automation → query
            edges.push({
              data: {
                id: `e_auto_${queryNodeId}`,
                source: act.automationId,
                target: queryNodeId,
              },
            });

            // Target DE node
            if (!nodes[act.targetDE])
              nodes[act.targetDE] = {
                data: {
                  id: act.targetDE,
                  label: act.targetDE,
                  type: "de",
                  isTarget: "true",
                },
              };

            // Edge: query → target DE with mode label
            edges.push({
              data: {
                id: `e_query_${act.targetDE}`,
                source: queryNodeId,
                target: act.targetDE,
                label: act.mode,
              },
            });

            // Source DEs from SQL
            const tableRegex = /\bFROM\s+([a-zA-Z0-9_.]+)|\bJOIN\s+([a-zA-Z0-9_.]+)/gi;
            let matches = [...act.queryText.matchAll(tableRegex)];
            let tables = matches.map((m) => m[1] || m[2]).filter(Boolean);
            tables.forEach((t) => {
              if (!nodes[t])
                nodes[t] = {
                  data: { id: t, label: t, type: "de", isTarget: "false" },
                };
              edges.push({
                data: {
                  id: `e_${t}_${queryNodeId}`,
                  source: t,
                  target: queryNodeId,
                },
              });
            });
          });

          const cyElements = Object.values(nodes).concat(edges);

          const cy = cytoscape({
            container: document.getElementById("cy"),
            elements: cyElements,
            style: [
              {
                selector: 'node[type="automation"]',
                style: {
                  shape: "round-rectangle",
                  "background-color": "#ff9800",
                  label: (ele) =>
                    `${ele.data("label")}`,
                  "text-valign": "top",
                  "text-halign": "center",
                  "text-margin-y": -15,
                  "font-size": "12px",
                  "font-weight": "bold",
                  padding: "15px",
                  "text-wrap": "wrap",
                },
              },
              {
                selector: 'node[type="query"]',
                style: {
                  shape: "diamond",
                  "background-color": "#4cafef",
                  color: "#fff",
                  label: "data(label)",
                  "text-valign": "center",
                  "text-halign": "center",
                  padding: "10px",
                  "text-wrap": "wrap",
                },
              },
              {
                selector: 'node[isTarget="true"]',
                style: {
                  shape: "rectangle",
                  "background-color": "#1e88e5",
                  color: "#fff",
                  label: "data(label)",
                  "font-size": "14px",
                  "font-weight": "bold",
                  "border-width": 3,
                  "border-color": "#0d47a1",
                  "text-valign": "center",
                  "text-halign": "center",
                  width: "label",
                  height: "label",
                  padding: "10px",
                  "text-wrap": "wrap",
                },
              },
              {
                selector: 'node[isTarget="false"]',
                style: {
                  shape: "rectangle",
                  "background-color": "#90caf9",
                  color: "#000",
                  label: "data(label)",
                  "font-size": "12px",
                  "text-valign": "center",
                  "text-halign": "center",
                  padding: "5px",
                },
              },
              {
                selector: "edge",
                style: {
                  width: 2,
                  "line-color": "#aaa",
                  "target-arrow-shape": "triangle",
                  "target-arrow-color": "#aaa",
                  "curve-style": "bezier",
                  label: "data(label)",
                  "font-size": "10px",
                  "text-rotation": "autorotate",
                  "text-margin-y": -10,
                },
              },
            ],
            layout: {
              name: "cose",
              animate: true,
              idealEdgeLength: 100,
              nodeOverlap: 20,
              refresh: 20,
              fit: true,
              padding: 30,
              randomize: true,
            },
            userZoomingEnabled: true,   // allows mouse wheel/pinch zoom
            minZoom: 0.5,               // minimum zoom level
            maxZoom: 2,                 // maximum zoom level
            zoom: 1 
          });

          // Click query node to show SQL
          cy.on("tap", 'node[type="query"]', (evt) => {
            alert(
              "SQL for " +
                evt.target.data("label") +
                ":\n\n" +
                evt.target.data("sql")
            );
          });
          select.addEventListener("change", () => {
            const selected = Array.from(select.selectedOptions).map(
              (o) => o.value
            );

            cy.nodes().forEach((n) => {
              if (selected.includes("all")) {
                n.show();
              } else {
                if (
                  selected.includes(n.data("automationId")) ||
                  selected.includes(n.data("id")) ||
                  (n.data("type") === "de" &&
                    edges.some(
                      (e) =>
                        e.data.source === n.data("id") &&
                        selected.includes(
                          cy.getElementById(e.data.target).data("automationId")
                        )
                    ))
                ) {
                  n.show();
                } else {
                  n.hide();
                }
              }
            });

            cy.edges().forEach((e) => {
              const src = cy.getElementById(e.data("source"));
              const tgt = cy.getElementById(e.data("target"));
              if (src.visible() && tgt.visible()) e.show();
              else e.hide();
            });
          });
          
        })
      .catch(error => {
          console.error("Error loading JSON files:", error);
      });

    </script>
  </body>
</html>
